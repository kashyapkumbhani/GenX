<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Generation History - Business Site Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="app-container">
        {% include 'templates/components/sidebar.html' %}
        
        <main class="content">
            <h1>Generation History</h1>
            <p>View your website generations and track progress in real-time.</p>
            
            <!-- Active Generations Section -->
            <div class="active-generations-section">
                <h2>Live Generation</h2>
                <div id="active-generations-container">
                    <!-- Active generations will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Legacy History Section (for backward compatibility) -->
            {% if history %}
            <div class="legacy-history-section">
                <h2>Legacy History</h2>
                <div class="history-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Version</th>
                                <th>Business Name</th>
                                <th>Website URL</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in history %}
                                <tr>
                                    <td>{{ item.version }}</td>
                                    <td>{{ item.business_name }}</td>
                                    <td>
                                        {% if item.website_url != 'N/A' %}
                                            <a href="{{ item.website_url }}" target="_blank">{{ item.website_url }}</a>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>{{ item.timestamp }}</td>
                                    <td>
                                        <a href="{{ item.path }}" target="_blank" class="btn-view">View</a>
                                        <a href="{{ item.path }}?edit=true" target="_blank" class="btn-edit">Edit Content</a>
                                        <a href="/download_version/{{ item.version }}" class="btn-download">Download ZIP</a>
                                        <button onclick="deleteVersion('{{ item.version }}')" class="btn-delete">Delete</button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            
            <!-- Empty State -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <p>No sites have been generated yet.</p>
                <a href="{{ url_for('dashboard') }}" class="btn">Generate Your First Site</a>
            </div>
        </main>
    </div>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script>
        let pollInterval;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadGenerations();
            startPolling();
        });
        
        function loadGenerations() {
            fetch('/all_generations_status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayGenerations(data.generations);
                    } else {
                        console.error('Failed to load generations:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading generations:', error);
                });
        }
        
        function displayGenerations(generations) {
            const activeContainer = document.getElementById('active-generations-container');
            const emptyState = document.getElementById('empty-state');
            
            // Filter only active generations
            const activeGenerations = generations.filter(g => g.status === 'queued' || g.status === 'generating');
            
            // Display active generations
            if (activeGenerations.length > 0) {
                activeContainer.innerHTML = activeGenerations.map(gen => createGenerationCard(gen, true)).join('');
                document.querySelector('.active-generations-section').style.display = 'block';
            } else {
                document.querySelector('.active-generations-section').style.display = 'none';
            }
            
            // Show empty state if no generations at all and no legacy history
            const hasAnyGenerations = generations.length > 0 || document.querySelector('.legacy-history-section');
            emptyState.style.display = hasAnyGenerations ? 'none' : 'block';
        }
        
        function createGenerationCard(generation, isActive) {
            const statusClass = `status-${generation.status}`;
            const progressBar = isActive ? `
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${generation.progress}%"></div>
                    </div>
                    <span class="progress-text">${generation.progress}%</span>
                </div>
            ` : '';
            
            const actions = generation.status === 'completed' ? `
                <div class="generation-actions">
                    <a href="${generation.preview_url}" target="_blank" class="btn-view">View Site</a>
                    <a href="${generation.preview_url}?edit=true" target="_blank" class="btn-edit">Edit Content</a>
                    <a href="/download_version/${generation.version}" class="btn-download">Download</a>
                    <button onclick="deleteGeneration('${generation.id}')" class="btn-delete">Delete</button>
                </div>
            ` : generation.status === 'failed' ? `
                <div class="generation-actions">
                    <button onclick="deleteGeneration('${generation.id}')" class="btn-delete">Delete</button>
                </div>
            ` : '';
            
            const createdDate = new Date(generation.created_at).toLocaleString();
            const message = generation.message || getStatusMessage(generation.status);
            
            return `
                <div class="generation-card ${statusClass}" data-id="${generation.id}">
                    <div class="generation-header">
                        <h3>${generation.business_name}</h3>
                        <span class="generation-status">${generation.status.toUpperCase()}</span>
                    </div>
                    <div class="generation-details">
                        <p><strong>Template:</strong> ${generation.template}</p>
                        <p><strong>Created:</strong> ${createdDate}</p>
                        <p><strong>Status:</strong> ${message}</p>
                    </div>
                    ${progressBar}
                    ${actions}
                </div>
            `;
        }
        
        function getStatusMessage(status) {
            const messages = {
                'queued': 'Waiting in queue...',
                'generating': 'Generating website...',
                'completed': 'Generation completed successfully',
                'failed': 'Generation failed'
            };
            return messages[status] || status;
        }
        
        function startPolling() {
            // Poll every 2 seconds for active generations
            pollInterval = setInterval(() => {
                const activeCards = document.querySelectorAll('.generation-card.status-queued, .generation-card.status-generating');
                if (activeCards.length > 0) {
                    loadGenerations();
                } else {
                    // Stop polling if no active generations
                    clearInterval(pollInterval);
                    // Restart polling after 10 seconds in case new generations start
                    setTimeout(startPolling, 10000);
                }
            }, 2000);
        }
        
        function deleteGeneration(generationId) {
            if (confirm('Are you sure you want to delete this generation? This action cannot be undone.')) {
                fetch(`/delete_generation/${generationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadGenerations(); // Refresh the list
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the generation.');
                });
            }
        }
        
        function deleteVersion(version) {
            if (confirm(`Are you sure you want to delete version ${version}? This action cannot be undone.`)) {
                fetch(`/delete_version/${version}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        location.reload(); // Refresh the page to update the list
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the version.');
                });
            }
        }
    </script>
</body>
</html>